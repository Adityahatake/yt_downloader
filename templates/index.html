<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Downloader</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script>
        let eventSource = null;

        function fetchFormats() {
            const url = document.getElementById("url").value.trim();
            if (!url) return alert("Please enter a YouTube URL.");

            fetch("/get_formats", {
                method: "POST",
                body: new FormData(document.getElementById("urlForm"))
            })
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById("formatSelect");
                select.innerHTML = "";
                if (data.error) {
                    alert(data.error);
                    return;
                }
                data.forEach(format => {
                    const option = document.createElement("option");
                    option.value = format.format_id;
                    option.textContent = `${format.resolution} (${format.ext})`;
                    select.appendChild(option);
                });
                document.getElementById("downloadSection").style.display = "block";
            })
            .catch(() => alert("Failed to fetch formats."));
        }

        function downloadVideo() {
            const url = document.getElementById("url").value.trim();
            const format = document.getElementById("formatSelect").value;
            if (!url || !format) return alert("Please select a format.");

            const formData = new FormData();
            formData.append("url", url);
            formData.append("format", format);

            fetch("/download", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById("progressContainer").style.display = "block";
                    trackProgress();
                }
            })
            .catch(() => alert("Failed to start download."));
        }

        function trackProgress() {
            if (eventSource) eventSource.close();
            eventSource = new EventSource("/progress");
            eventSource.onmessage = function(event) {
                const progressData = JSON.parse(event.data);
                for (let file in progressData) {
                    const data = progressData[file];
                    const percent = parseFloat(data.percent.replace('%', '')) || 0;
                    document.getElementById("progressBar").value = percent;
                    document.getElementById("progressText").textContent = `Progress: ${data.percent}`;
                    document.getElementById("sizeText").textContent = `Size: ${data.size}`;
                    document.getElementById("speedText").textContent = `Speed: ${data.speed}`;
                    document.getElementById("etaText").textContent = `ETA: ${data.eta}`;
                    document.getElementById("fragmentText").textContent = `Fragments: ${data.fragments}`;
                    if (data.percent === "100%") {
                        eventSource.close();
                        eventSource = null;
                        document.getElementById("progressText").textContent = "Download complete!";
                    }
                }
            };
        }

        function cancelDownload() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                document.getElementById("progressContainer").style.display = "none";
                alert("Download canceled.");
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <h2>YouTube Video Downloader</h2>
        <form id="urlForm" onsubmit="return false;">
            <label for="url">YouTube URL</label>
            <input type="text" id="url" name="url" placeholder="Paste YouTube video URL here" autocomplete="off" required>
            <button type="button" onclick="fetchFormats()">Get Formats</button>
        </form>

        <div id="downloadSection" style="display: none;">
            <label for="formatSelect">Select Format</label>
            <select id="formatSelect" required></select>
            <button type="button" onclick="downloadVideo()">Download</button>
        </div>

        <div id="progressContainer" style="display: none; margin-top: 24px;">
            <h3 style="color:#ff4757; margin-bottom:10px;">Download Progress</h3>
            <progress id="progressBar" value="0" max="100"></progress>
            <div class="progress-info" id="progressText">Waiting...</div>
            <div class="progress-info" id="sizeText"></div>
            <div class="progress-info" id="speedText"></div>
            <div class="progress-info" id="etaText"></div>
            <div class="progress-info" id="fragmentText"></div>
            <button type="button" onclick="cancelDownload()" style="margin-top: 10px;